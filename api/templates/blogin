<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>로그인</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{
      --bg:#ffffff; --text:#111827; --muted:#6b7280;
      --card:#f9fafb; --border:#d1d5db;
      --accent:#2563eb; --accent-hover:#1d4ed8;
      --ok:#16a34a; --err:#b91c1c;
      --radius:12px; --shadow:0 4px 12px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Pretendard,sans-serif;background:var(--bg);color:var(--text)}
    .card{max-width:420px;margin:60px auto;padding:24px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    h2{margin:0 0 8px;font-size:24px}
    p.sub{margin:0 0 18px;color:var(--muted);font-size:14px}
    input{width:100%;padding:12px;margin-top:10px;border-radius:10px;border:1px solid var(--border);background:#fff;color:var(--text);font-size:14px}
    button{margin-top:16px;width:100%;padding:12px;border:none;border-radius:10px;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    button:hover{background:var(--accent-hover)}
    .meta{margin-top:10px;font-size:14px}
    .meta a{color:var(--accent);text-decoration:none}
    #login-result{margin-top:12px;font-size:14px}
  </style>

  <script>
    // ✅ 세션 유지 대신 브라우저 닫으면 자동 로그아웃(sessionStorage 사용)
    (function guardWhenLoggedIn(){
      const token = sessionStorage.getItem("access_token");
      if(token){ location.replace("/"); }
    })();

    window.addEventListener("pageshow",(e)=>{
      const token = sessionStorage.getItem("access_token");
      if(token){ location.replace("/"); }
    });

    document.addEventListener("DOMContentLoaded", ()=>{
      document.getElementById("login-btn").addEventListener("click", async ()=>{
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        const box = document.getElementById("login-result");
        box.textContent = "로그인 중...";

        try {
          const res = await fetch("/api/login", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ email, password })
          });
          const json = await res.json();

          if(json.ok){
            // ✅ sessionStorage에 로그인 세션 저장 (브라우저 닫으면 사라짐)
            sessionStorage.setItem("access_token", json.access_token);
            sessionStorage.setItem("user_role", json.user.role || "user");

            if(json.expires_in){
              const expiry = Math.floor(Date.now()/1000) + json.expires_in;
              sessionStorage.setItem("token_expiry", expiry);
            }

            box.innerHTML = "<span style='color:var(--ok)'>로그인 성공!</span>";
            location.replace("/"); // 메인 페이지로 이동
          }else{
            box.innerHTML = "<span style='color:var(--err)'>에러: "+ (json.error || "invalid_credentials") +"</span>";
          }
        }catch(err){
          box.innerHTML = "<span style='color:var(--err)'>에러: "+ (err?.message || err) +"</span>";
        }
      });
    });
  </script>
</head>

<body>
  <div class="card">
    <h2>로그인</h2>
    <p class="sub">이메일과 비밀번호를 입력해 주세요.</p>

    <form id="login-form" onsubmit="return false;">
      <input type="email" id="email" placeholder="이메일" required>
      <input type="password" id="password" placeholder="비밀번호" required>
      <button type="button" id="login-btn">로그인</button>
    </form>

    <div id="login-result"></div>
    <div class="meta">처음이신가요? <a href="/register">회원가입</a></div>
  </div>
</body>
</html>

