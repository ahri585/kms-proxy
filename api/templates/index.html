<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>KMS 암호화 테스트 (로그인 보호)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --b:#111827; --m:#6b7280; --bg:#f8fafc; --card:#fff; --br:#e5e7eb; --blue:#2563eb; --green:#065f46; --red:#b91c1c; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); margin: 0; padding: 24px; color: var(--b);}
    .wrap { max-width: 920px; margin: 0 auto; }
    h1 { margin: 0 0 16px; font-size: 22px; }
    .card { background: var(--card); border:1px solid var(--br); border-radius: 14px; padding: 16px; box-shadow: 0 4px 14px rgba(0,0,0,.05); }
    label { display:block; font-size: 13px; color: var(--m); margin: 10px 0 6px; }
    input, textarea { width:100%; box-sizing: border-box; padding:10px 12px; border:1px solid var(--br); border-radius:10px; background:#fff; font:inherit; }
    textarea { min-height:120px; resize: vertical; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-top: 10px;}
    .btn { cursor:pointer; border:0; padding:10px 16px; border-radius:10px; font-weight:600; }
    .btn-primary { background:var(--blue); color:#fff; }
    .btn-secondary { background:#e5e7eb; }
    .out { margin-top: 16px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .muted { color: var(--m); font-size: 12px;}
    .copy { font-size:12px; cursor:pointer; color:var(--blue); margin-left:8px; }
    .err { color:var(--red); white-space:pre-wrap; margin-top:8px; }
    .ok { color:var(--green); }

    /* top bar */
    .top { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .top .right { display:flex; align-items:center; gap:10px; }
    .link { color:var(--blue); text-decoration:none; font-weight:600; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1 style="margin:0;">KMS 암호화 테스트</h1>
      <div class="right">
        <span id="user-span" class="muted">확인 중...</span>
        <button id="btnLogout" class="btn btn-secondary">로그아웃</button>
      </div>
    </div>

    <div class="card">
      <label for="plain">평문 데이터 (string)</label>
      <textarea id="plain" placeholder="여기에 평문을 입력하세요">Hello KMS + AES-GCM!</textarea>

      <label for="aad">AAD (선택)</label>
      <input id="aad" placeholder="예: kms-proxy-v1 (옵션)" />

      <div class="row">
        <button id="btnEncrypt" class="btn btn-primary">Encrypt</button>
        <span id="status" class="muted"></span>
      </div>

      <div class="out">
        <label>ciphertext (base64) <span class="copy" data-copy="ciphertext">복사</span></label>
        <textarea id="ciphertext" class="mono" readonly placeholder="암호문 (ct||tag, base64)"></textarea>

        <label>iv (base64) <span class="copy" data-copy="iv">복사</span></label>
        <input id="iv" class="mono" readonly placeholder="IV (base64)" />

        <label>wdek (base64) <span class="copy" data-copy="wdek">복사</span></label>
        <textarea id="wdek" class="mono" readonly placeholder="KMS가 감싼 DEK (base64)"></textarea>

        <div id="errBox" class="err"></div>
        <div class="muted" style="margin-top:6px;">
          * 같은 (키, AAD)로 <b>같은 IV를 재사용하면 안 됩니다</b>. 서버는 매번 무작위 96-bit IV를 생성합니다.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ----- Auth helpers -----
    const getToken = () => localStorage.getItem("access_token");
    const setUserName = (name) => {
      const span = document.getElementById("user-span");
      span.textContent = name ? `안녕하세요, ${name}님` : "로그인 필요";
    };

    async function ensureLoggedIn() {
      const token = getToken();
      if (!token) {
        // 토큰 없으면 로그인 페이지로
        location.href = "/login";
        return;
      }
      // 토큰이 있으면 /api/me로 검증 및 사용자 정보 노출
      try {
        const r = await fetch("/api/me", { headers: { Authorization: "Bearer " + token }});
        if (r.status === 401) { // 만료/유효하지 않음
          localStorage.removeItem("access_token");
          location.href = "/login";
          return;
        }
        const j = await r.json();
        setUserName(j?.user?.username || j?.user?.email || "사용자");
      } catch {
        setUserName("사용자");
      }
    }

    document.getElementById("btnLogout").addEventListener("click", () => {
      localStorage.removeItem("access_token");
      location.href = "/login";
    });

    // ----- DOM refs -----
    const $ = (id) => document.getElementById(id);
    const plain = $('plain');
    const aad = $('aad');
    const btn = $('btnEncrypt');
    const status = $('status');
    const errBox = $('errBox');
    const ciphertext = $('ciphertext');
    const iv = $('iv');
    const wdek = $('wdek');

    // 복사 기능
    document.querySelectorAll('.copy').forEach(el=>{
      el.addEventListener('click', () => {
        const id = el.dataset.copy;
        const target = document.getElementById(id);
        const val = target.value || target.innerText || '';
        navigator.clipboard.writeText(val).then(()=>{
          const prev = el.innerText;
          el.innerText = '복사됨!';
          setTimeout(()=> el.innerText = prev, 900);
        });
      });
    });

    btn.addEventListener('click', async () => {
      errBox.innerText = '';
      status.innerText = '암호화 중...';
      btn.disabled = true;

      const token = getToken();
      if (!token) { location.href = "/login"; return; }

      try {
        const body = { data: plain.value };
        if (aad.value.trim() !== '') body.aad = aad.value.trim();

        // ✅ Authorization 헤더 추가
        const r = await fetch('/api/encrypt', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(body),
        });

        // 401이면 로그인 만료 처리
        if (r.status === 401) {
          localStorage.removeItem("access_token");
          location.href = "/login";
          return;
        }

        const j = await r.json().catch(()=> ({}));
        if (!r.ok || !j.ok) {
          const msg = (j && j.error) ? j.error : `HTTP ${r.status}`;
          throw new Error(msg);
        }

        ciphertext.value = j.ciphertext || '';
        iv.value = j.iv || '';
        wdek.value = j.wdek || '';
        status.innerHTML = '<span class="ok">완료!</span>';
      } catch (e) {
        status.innerText = '';
        errBox.innerText = 'Encrypt 오류: ' + (e && e.message ? e.message : e);
      } finally {
        btn.disabled = false;
      }
    });

    // 초기 진입 시 로그인 보장 + 사용자명 표시
    ensureLoggedIn();
  </script>
</body>
</html>

