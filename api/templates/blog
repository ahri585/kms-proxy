<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ê´€ë¦¬ì ë¡œê·¸ ê¸°ë¡</title>
  <style>
    body { font-family: sans-serif; margin: 30px; }
    h2 { margin-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #f2f2f2; }
    .error { color: red; font-weight: bold; margin-top: 20px; }
    .info { color: #333; margin-top: 10px; }
    #reload { margin-top: 10px; padding: 6px 12px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>ìµœê·¼ ê°ì‚¬ ë¡œê·¸ (ê´€ë¦¬ì ì „ìš©)</h2>
  <div class="info">ì´ í˜ì´ì§€ëŠ” ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
  <div id="error" class="error"></div>
  <button id="reload" onclick="loadLogs()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>

  <table id="logTable" style="display:none;">
    <thead>
      <tr>
        <th>ì‘ì—…</th>
        <th>ìƒíƒœ</th>
        <th>ì‚¬ìš©ì</th>
        <th>IP</th>
        <th>ë¸Œë¼ìš°ì €</th>
        <th>ë³€ê²½ì‹œê°</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    async function loadLogs() {
      const errorDiv = document.getElementById("error");
      const table = document.getElementById("logTable");
      errorDiv.textContent = "";
      table.style.display = "none";

      // âœ… 1. ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ í† í°/ê¶Œí•œ ë¶ˆëŸ¬ì˜¤ê¸°
      const token = localStorage.getItem("access_token");
      const role = localStorage.getItem("user_role");

      if (!token) {
        errorDiv.textContent = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.";
        return;
      }
      if (role !== "admin") {
        errorDiv.textContent = "ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
        return;
      }

      // âœ… 2. ì„œë²„ ìš”ì²­
      try {
        const res = await fetch("/api/audit/recent", {
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          }
        });

        // í† í° ë§Œë£Œ ë˜ëŠ” ì¸ì¦ ì‹¤íŒ¨ ì‹œ
        if (res.status === 401) {
          errorDiv.textContent = "ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”.";
          localStorage.removeItem("access_token");
          return;
        }

        const data = await res.json();

        if (!data.ok) {
          errorDiv.textContent = "ì ‘ê·¼ ì‹¤íŒ¨: " + (data.message || data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
          return;
        }

        // âœ… 3. í…Œì´ë¸” ì±„ìš°ê¸°
        const tbody = table.querySelector("tbody");
        tbody.innerHTML = "";
        data.logs.forEach(log => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${log.op || ""}</td>
            <td>${log.status || ""}</td>
            <td>${log.user_id || ""}</td>
            <td>${log.ip || ""}</td>
            <td>${log.browser || ""}</td>
            <td>${new Date(log.changed_at).toLocaleString("ko-KR")}</td>
          `;
          tbody.appendChild(tr);
        });

        table.style.display = "table";

      } catch (err) {
        console.error("ìš”ì²­ ì‹¤íŒ¨:", err);
        errorDiv.textContent = "ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
      }
    }

    // âœ… í˜ì´ì§€ ì§„ì… ì‹œ ìë™ ì‹¤í–‰
    loadLogs();
  </script>
</body>
</html>

