<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>ê´€ë¦¬ì ë¡œê·¸ ê¸°ë¡</title>
  <style>
    body { font-family: sans-serif; margin: 30px; background: #f5f5f5; }
    h2 { margin-bottom: 10px; color: #333; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
    th { background: #2c3e50; color: white; font-weight: bold; }
    .error { color: red; font-weight: bold; margin-top: 20px; padding: 10px; background: #ffe6e6; border-radius: 4px; }
    .info { color: #333; margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 4px; }
    #reload { 
      margin-top: 10px; 
      padding: 8px 16px; 
      cursor: pointer; 
      background: #2196F3; 
      color: white; 
      border: none; 
      border-radius: 4px;
      font-size: 14px;
    }
    #reload:hover { background: #1976D2; }
    
    /* ì‘ì—… íƒ€ì…ë³„ ìƒ‰ìƒ */
    .op-encrypt { 
      background: #e8f5e9; 
      color: #2e7d32; 
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 3px;
    }
    .op-decrypt { 
      background: #fff3e0; 
      color: #ef6c00; 
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 3px;
    }
    
    /* ìƒíƒœë³„ ìƒ‰ìƒ */
    .status-success { 
      background: #2196F3; 
      color: white; 
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 3px;
    }
    .status-failed { 
      background: #f44336; 
      color: white; 
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 3px;
    }
    
    /* í–‰ í˜¸ë²„ íš¨ê³¼ */
    tbody tr:hover { background: #f5f5f5; }
    
    /* ì§ìˆ˜ í–‰ ë°°ê²½ */
    tbody tr:nth-child(even) { background: #fafafa; }
  </style>
</head>
<body>
  <h2>ìµœê·¼ ê°ì‚¬ ë¡œê·¸ (ê´€ë¦¬ì ì „ìš©)</h2>
  <div class="info">ì´ í˜ì´ì§€ëŠ” ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
  <div id="error" class="error" style="display:none;"></div>
  <button id="reload" onclick="loadLogs()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
  <table id="logTable" style="display:none;">
    <thead>
      <tr>
        <th>ì‘ì—…</th>
        <th>ìƒíƒœ</th>
        <th>ì‚¬ìš©ì</th>
        <th>IP</th>
        <th>ë¸Œë¼ìš°ì €</th>
        <th>ë³€ê²½ì‹œê°„</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <script>
    async function loadLogs() {
      const errorDiv = document.getElementById("error");
      const table = document.getElementById("logTable");
      errorDiv.textContent = "";
      errorDiv.style.display = "none";
      table.style.display = "none";
      
      // sessionStorageì—ì„œ í† í°/ê¶Œí•œ ë¶ˆëŸ¬ì˜¤ê¸°
      const token = sessionStorage.getItem("token") || 
                    sessionStorage.getItem("access_token") || 
                    sessionStorage.getItem("jwt_token");
      
      const role = sessionStorage.getItem("role") || 
                   sessionStorage.getItem("user_role");
      
      console.log("Token:", token ? "ì¡´ì¬í•¨" : "ì—†ìŒ");  // ë””ë²„ê¹…ìš©
      console.log("Role:", role);    // ë””ë²„ê¹…ìš©
      
      if (!token) {
        errorDiv.textContent = "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.";
        errorDiv.style.display = "block";
        return;
      }
      
      if (role !== "admin") {
        errorDiv.textContent = "ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
        errorDiv.style.display = "block";
        return;
      }
      
      // ì„œë²„ ìš”ì²­
      try {
        const res = await fetch("/api/audit/recent", {
          headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
          }
        });
        
        // í† í° ë§Œë£Œ ë˜ëŠ” ì¸ì¦ ì‹¤íŒ¨ ì‹œ
        if (res.status === 401) {
          errorDiv.textContent = "ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.";
          errorDiv.style.display = "block";
          sessionStorage.clear();
          return;
        }
        
        if (res.status === 403) {
          errorDiv.textContent = "ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.";
          errorDiv.style.display = "block";
          return;
        }
        
        const data = await res.json();
        
        if (!data.ok) {
          errorDiv.textContent = "ì ‘ê·¼ ì‹¤íŒ¨: " + (data.message || data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜");
          errorDiv.style.display = "block";
          return;
        }
        
        // í…Œì´ë¸” ì±„ìš°ê¸°
        const tbody = table.querySelector("tbody");
        tbody.innerHTML = "";
        
        if (!data.logs || data.logs.length === 0) {
          errorDiv.textContent = "í‘œì‹œí•  ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤.";
          errorDiv.style.display = "block";
          return;
        }
        
        data.logs.forEach(log => {
          const tr = document.createElement("tr");
          
          // ì‘ì—… íƒ€ì… (ENCRYPT/DECRYPT)
          const opText = (log.op || "-").toUpperCase();
          let opClass = "";
          if (opText === "ENCRYPT") {
            opClass = "op-encrypt";
          } else if (opText === "DECRYPT") {
            opClass = "op-decrypt";
          }
          
          // ìƒíƒœ (SUCCESS/FAILED)
          const statusText = (log.status || "-").toUpperCase();
          let statusClass = "";
          if (statusText === "SUCCESS") {
            statusClass = "status-success";
          } else if (statusText === "FAILED") {
            statusClass = "status-failed";
          }
          
          tr.innerHTML = `
            <td><span class="${opClass}">${opText}</span></td>
            <td><span class="${statusClass}">${statusText}</span></td>
            <td>${log.user_id || "-"}</td>
            <td>${log.ip || "-"}</td>
            <td>${log.browser || "-"}</td>
            <td>${log.changed_at ? new Date(log.changed_at).toLocaleString("ko-KR") : "-"}</td>
          `;
          tbody.appendChild(tr);
        });
        
        table.style.display = "table";
        
      } catch (err) {
        console.error("ìš”ì²­ ì‹¤íŒ¨:", err);
        errorDiv.textContent = "ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
        errorDiv.style.display = "block";
      }
    }
    
    // í˜ì´ì§€ ì§„ì… ì‹œ ìë™ ì‹¤í–‰
    loadLogs();
  </script>
</body>
</html>
