<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>최근 감사 로그 (관리자 전용)</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body { background-color: #f7f9fc; }
      h2 { margin-top: 20px; font-weight: 700; color: #333; }
      table {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 8px rgba(0,0,0,0.05);
      }
      .badge-success { background-color: #28a745; }
      .badge-failed { background-color: #dc3545; }
      .badge-encrypt { background-color: #007bff; }
      .badge-decrypt { background-color: #ffc107; color: black; }
      .table th, .table td { vertical-align: middle; }
    </style>
  </head>
  <body class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2>🔍 최근 감사 로그 (관리자 전용)</h2>
      <button class="btn btn-primary btn-sm" id="refresh">🔄 새로고침</button>
    </div>

    <p class="alert alert-info p-2">
      이 페이지는 관리자만 접근 가능합니다.
    </p>

    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>작업</th>
          <th>상태</th>
          <th>IP</th>
          <th>브라우저</th>
          <th>변경 시각</th>
        </tr>
      </thead>
      <tbody id="log-body">
        <tr><td colspan="5" class="text-center text-muted">로딩 중...</td></tr>
      </tbody>
    </table>

    <script>
      async function loadLogs() {
        const res = await fetch("/api/crypto/audit/recent");
        const data = await res.json();
        const body = document.getElementById("log-body");
        body.innerHTML = "";

        if (!data.ok || !data.logs || !data.logs.length) {
          body.innerHTML = '<tr><td colspan="5" class="text-center text-muted">표시할 로그가 없습니다.</td></tr>';
          return;
        }

        data.logs.forEach((log) => {
          const opClass = log.op === "ENCRYPT" ? "badge-encrypt" : "badge-decrypt";
          const stClass = log.status === "SUCCESS" ? "badge-success" : "badge-failed";
          const ua = log.user_agent ? log.user_agent.slice(0, 60) + "..." : "";
          const row = `
            <tr>
              <td><span class="badge ${opClass}">${log.op}</span></td>
              <td><span class="badge ${stClass}">${log.status}</span></td>
              <td>${log.ip || "-"}</td>
              <td class="text-muted small">${ua}</td>
              <td>${log.changed_at}</td>
            </tr>`;
          body.insertAdjacentHTML("beforeend", row);
        });
      }

      document.getElementById("refresh").addEventListener("click", loadLogs);
      loadLogs();
    </script>
  </body>
</html>

